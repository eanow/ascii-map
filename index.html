<head>
<script src="jquery-3.6.3.min.js"></script>
</head>

<script type="text/javascript">
let drag="up";
let drag_corner_row=0;
let drag_corner_col=0;
let submap="ground";
let picked=null;
let draw=0;
let map_rows=0;
let map_cols=0;
const empty_tile='█';

const map_mapping={
    "ground": {
        "D": ['.',',',':',';','∙'],
        "G": ['"','‟','‘','`'],
        "R": ['°','σ','Ω',],
        "W": ["≈",'~'],
        "T": ["+"],
        "H": ["-"],
    },
    "wall": {
        "W": ["╬"],
        "N": [")"],
        "T": ["O"],
        "D": ["∩"],
    },
    "actor": {
        "P": ["P"],
        "M": ["M"],
    }
}

function synthesize_map() {
    //create a combined map by merging all layers
    let line="";
    let symbol_set=null;
    $("#clip_area").val("");
    for (let ii=0; ii<map_rows; ii+=1) {
        line="";
        for (let jj=0; jj<map_cols; jj+=1) {
            ground_layer=$(".ground_map").children("#"+ii).children("#"+jj).text();
            wall_layer=$(".wall_map").children("#"+ii).children("#"+jj).text();
            actor_layer=$(".actor_map").children("#"+ii).children("#"+jj).text();
            temp_layer=$(".temp_map").children("#"+ii).children("#"+jj).text();
            symbol_set=map_mapping.ground[ground_layer];
            console.log("using ground");
            //Temp > actors > wall > ground, assuming not empty tile
            if (wall_layer !== empty_tile) {
                symbol_set=map_mapping.wall[wall_layer];
                console.log("using Wall");
            }
            if (actor_layer !== empty_tile) {
                symbol_set=map_mapping.actor[actor_layer];
                console.log("using actor");
            }
            if (temp_layer !== empty_tile) {
                symbol_set=map_mapping.ground[temp_layer];
                console.log("using character");
            }
            paint=symbol_set[(Math.random() * symbol_set.length) | 0];
            $(".map_canvas").children("#"+ii).children("#"+jj).text(paint);
            line=line+paint;
        }
        if (ii===0) {
            update_clip=$("#clip_area").val()+line;
        } else {
            update_clip=$("#clip_area").val()+"\n"+line;
        }
        $("#clip_area").val(update_clip);
    }
}

function current_marker() {
    let rval="0";
    //base on palette
    switch(submap) {
        case "ground":
            picked = $('input[name="ground_material"]:checked').val();
            console.log(picked);
            switch(picked) {
                case "ground_dirt":
                    rval='D';
                    break;
                case "ground_grass":
                    rval='G';
                    break;
                case "ground_rock":
                    rval='R';
                    break;
                case "ground_water":
                    rval='W';
                    break;
                case "ground_tile":
                    rval='T';
                    break;
                case "ground_wood":
                    rval='H';
                    break;
            }
            break;
        case "wall":
            picked = $('input[name="wall_material"]:checked').val();
            console.log(picked);
            switch(picked) {
                case "wall_constructed":
                    rval='W';
                    break;
                case "wall_natural":
                    rval='N';
                    break;
                case "wall_terrain":
                    rval='T';
                    break;
                case "wall_door":
                    rval='D';
                    break;   
            }
            break;
        case "actor":
            picked = $('input[name="actor_token"]:checked').val();
            console.log(picked);
            switch(picked) {
                case "actor_player":
                    rval='P';
                    break;
                case "actor_monster":
                    rval='M';
                    break; 
            }
            break;
    }
    return rval;
}
function edit_ground() {
    submap="ground";
    $("#ground_palette").css('visibility', 'visible');
    $("#wall_palette").css('visibility', 'hidden');
    $("#actor_palette").css('visibility', 'hidden');
}
function edit_wall() {
    submap="wall";
    $("#ground_palette").css('visibility', 'hidden');
    $("#wall_palette").css('visibility', 'visible');
    $("#actor_palette").css('visibility', 'hidden');
}
function edit_actor() {
    submap="actor";
    $("#ground_palette").css('visibility', 'hidden');
    $("#wall_palette").css('visibility', 'hidden');
    $("#actor_palette").css('visibility', 'visible');
}
function click_rewrite() {
    let myCol = $(this).attr("id");
    let myRow = $(this).parent().attr("id");
    $("#col_display").text(myCol);
    $("#row_display").text(myRow);
    let paint=current_marker();
    switch(submap) {
        /*case "ground":
            $(".ground_map").children("#"+myRow).children("#"+myCol).text(paint);
            break;*/
        /*case "wall":
            $(".wall_map").children("#"+myRow).children("#"+myCol).text(paint);
            break;*/
        case "actor":
            $(".actor_map").children("#"+myRow).children("#"+myCol).text(paint);
            break;
    }
}
function clear_map(submap) {
    for (let ii = 0; ii < map_cols; ii+=1) {
        for (let jj= 0; jj < map_rows; jj+=1) {
            switch (submap) {
                case "temp":
                    $(".temp_map").children("#"+jj).children("#"+ii).text(empty_tile);
                    break;
            }
        }
    }
}
function fresh_map() {
    //get input
    //map_rows=parseInt($("#num_rows").val(),10);
    map_rows=parseInt(document.getElementById("num_rows").value,10);
    //map_cols=parseInt($("#num_cols").val(),10);
    map_cols=parseInt(document.getElementById("num_cols").value,10);
    document.getElementById("clip_area").textContent="";
    //empty the map area
    document.getElementById("map_canvas").replaceChildren();
    //empty the holders
    document.getElementById("ground_map").replaceChildren();
    document.getElementById("wall_map").replaceChildren();
    document.getElementById("actor_map").replaceChildren();
    document.getElementById("temp_map").replaceChildren();
    //fill with map_rows worth of p elements
    for(let ii=0; ii<map_rows; ii+=1) {
        let new_row=document.createElement("p");
        new_row.id=ii;
        new_row.className="map_pixel";
        //let new_row="<p class=\"map_pixel\" id=\""+ii+"\"></p>";
        document.getElementById("ground_map").append(new_row.cloneNode(true));
        document.getElementById("temp_map").append(new_row.cloneNode(true));
        document.getElementById("wall_map").append(new_row.cloneNode(true));
        document.getElementById("actor_map").append(new_row.cloneNode(true));
        document.getElementById("map_canvas").append(new_row.cloneNode(true));
        //$( ".map_canvas" ).append("<p class=\"map_pixel\" id=\""+ii+"\"></p>");
        //$( ".temp_map").append("<p class=\"map_pixel\" id=\""+ii+"\"></p>");
        //$( ".ground_map" ).append("<p class=\"map_pixel\" id=\""+ii+"\"></p>");
        //$( ".wall_map" ).append("<p class=\"map_pixel\" id=\""+ii+"\"></p>");
        //$( ".actor_map" ).append("<p class=\"map_pixel\" id=\""+ii+"\"></p>");
    }
    //fill each p element with map_cols span elements
    for (let jj=0; jj<map_cols; jj+=1) {
        $('p.map_pixel').append("<span id=\""+jj+"\">"+empty_tile+"</span>");
    }
    //start will a full dirt ground
    update_square(0,map_cols,0,map_rows,"ground");
    console.log("Creating Fresh Map");
    synthesize_map();

    $('p.map_pixel span').click(
        click_rewrite
    );

    $('p.map_pixel span').mousedown(
        function() {
            //functionality will alter based on mode
            switch(submap) {
                case "ground":
                    drag_corner_col = $(this).attr("id");
                    drag_corner_row = $(this).parent().attr("id");
                    drag = "down"
                    break;
                case "wall":
                    let paint=current_marker();
                    let myCol = $(this).attr("id");
                    let myRow = $(this).parent().attr("id");
                    $(".wall_map").children("#"+myRow).children("#"+myCol).text(paint);
                    synthesize_map();  
                    break;
            }
            $('#state').text("Down");
            draw=1;
        }
    );

    $('p.map_pixel span').mouseup(
        function() {
            //functionality will alter based on mode
            switch(submap) {
                case "ground":
                    myCol = $(this).attr("id");
                    myRow = $(this).parent().attr("id");
                    drag = "up";
                    update_square(drag_corner_col,myCol,drag_corner_row,myRow,"ground");
                    synthesize_map();
                    break;
            }
            $('#state').text("Up");
            draw=0;
        }
    );

    $('p.map_pixel span').hover(
        function() {
            if (draw === 1) {
                let myCol = $(this).attr("id");
                let myRow = $(this).parent().attr("id");
                let paint=current_marker();
                switch(submap) {
                    case "wall":
                        $(".wall_map").children("#"+myRow).children("#"+myCol).text(paint);
                        synthesize_map();
                    break;
                    case "ground":
                        clear_map("temp");
                        update_square(drag_corner_col,myCol,drag_corner_row,myRow,"temp");
                        synthesize_map();
                    break;
                }
            }
        }
    );
}
function update_square(x1, x2, y1, y2, submap) {
    //swap if first is larger
    if (parseInt(x1,10)>parseInt(x2,10)) {
        drawX1=parseInt(x2,10);
        drawX2=parseInt(x1,10);
    } else {
        drawX1=parseInt(x1,10);
        drawX2=parseInt(x2,10);
    }
    if (parseInt(y1,10)>parseInt(y2,10)) {
        drawY1=parseInt(y2,10);
        drawY2=parseInt(y1,10);
    } else {
        drawY1=parseInt(y1,10);
        drawY2=parseInt(y2,10);
    }
    console.log("drawing a square");
    console.log(drawX1+" "+drawX2+" "+drawY1+" "+drawY2)
    let paint=current_marker();
    for (ii=drawX1; ii<=drawX2; ii++) {
        for (jj=drawY1; jj<=drawY2; jj++) {
            switch(submap) {
                case "ground":
                    $(".ground_map").children("#"+jj).children("#"+ii).text(paint);
                    break;
                case "temp":
                    $(".temp_map").children("#"+jj).children("#"+ii).text(paint);
                    break;
            }
        }
    }
}
</script>

<style type='text/css'>
p.map_pixel {
font-family: monospace;
line-height: 0em;
font-size: 30;
-moz-user-select: -moz-none;
-khtml-user-select: none;
-webkit-user-select: none;
-o-user-select: none;
user-select: none;
}
</style>
<p></p>
<div style="width: 100%; display:table;">
    <div style="display: table-row;">
        <div class="map_canvas" id="map_canvas" style="display: table-cell; width: 5%; margin:10;">

        </div>
        <div class="drawing_palette" style="display: table-cell; width: auto; float:left;margin:10;"></div>
            <div style="display: table-row;">
                <div class="palette_select" style="display: table-cell;">
                    <button onclick="edit_ground()">Ground</button><br />
                    <button onclick="edit_wall()">Walls</button><br />
                    <button onclick="edit_actor()">Actors</button><br />
                </div>
            </div>
            <!-- palette for ground; stuff like dirt, grass, interior tile, etc -->
            <div style="display: table-row; visibility: visible;" id="ground_palette">
                <div style="display: table-cell;">
                    <input type="radio" name="ground_material" value="ground_dirt" id="ground_dirt" checked>
                    <label for="ground_dirt">Dirt</label>
                    <br />
                    <input type="radio" name="ground_material" value="ground_grass" id="ground_grass">
                    <label for="ground_grass">Grass</label>
                    <br />
                    <input type="radio" name="ground_material" value="ground_rock" id="ground_rock">
                    <label for="ground_rock">Rocky</label>
                    <br />
                    <input type="radio" name="ground_material" value="ground_water" id="ground_water">
                    <label for="ground_water">Water</label>
                    <br />
                    <input type="radio" name="ground_material" value="ground_tile" id="ground_tile">
                    <label for="ground_tile">Tile/Finished Stone</label>
                    <br />
                    <input type="radio" name="ground_material" value="ground_wood" id="ground_wood">
                    <label for="ground_wood">Wooden</label>
                </div>
            </div>
            <!-- palette for walls -->
            <div style="display: table-row; visibility: hidden;" id="wall_palette">
                <div style="display: table-cell;">
                    <input type="radio" name="wall_material" value="wall_constructed" id="wall_constructed" checked>
                    <label for="wall_constructed">Constructed Wall</label>
                    <br />
                    <input type="radio" name="wall_material" value="wall_natural" id="wall_natural">
                    <label for="wall_natural">Natural Wall</label>
                    <br />
                    <input type="radio" name="wall_material" value="wall_terrain" id="wall_terrain">
                    <label for="wall_terrain">Terrain Obstactle</label>
                    <br />
                    <input type="radio" name="wall_material" value="wall_door" id="wall_door">
                    <label for="wall_door">Door</label>
                    <br />
                </div>
            </div>
            <!-- palette for actors -->
            <div style="display: table-row; visibility: hidden;" id="actor_palette">
                <div style="display: table-cell;">
                    <input type="radio" name="actor_token" value="actor_player" id="wall_constructed" checked>
                    <label for="actor_player">Player Character</label>
                    <br />
                    <input type="radio" name="actor_token" value="actor_monster" id="wall_natural">
                    <label for="actor_monster">Monster</label>
                    <br />
                </div>
            </div>
        </div>
    </div>
</div>
<br />
<hr>

<p>11111</p>
<p></p>
<!-- debug -->
State:<span id="state"></span>
X:<span id="col_display"></span>
Y:<span id="row_display"></span>
<br />
<!-- create map -->
<label for="num_rows">Rows:</label>
<input type="number" id="num_rows" name="Rows">
<label for="num_cols">Columns:</label>
<input type="number" id="num_cols" name="Cols">
<button onclick="fresh_map()">Create New Map</button> 
<button onclick="synthesize_map()">Merge Map</button>
<br />
<!--holder maps-->
<div style="display: table;">
    <div style="display: table-row;"></div>
        <div class="temp_map" id="temp_map" style="display: table-cell;"></div>
        <div style="width: 10px; display: table-cell;"></div>
        <div class="ground_map" id="ground_map" style="display: table-cell;"></div>
        <div style="width: 10px; display: table-cell;"></div>
        <div class="wall_map" id="wall_map" style="display: table-cell;"></div>
        <div style="width: 10px; display: table-cell;"></div>
        <div class="actor_map" id="actor_map" style="display: table-cell;"></div>
    </div>
</div>
<!--copypasta area-->
<textarea id="clip_area">
</textarea>
